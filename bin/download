#!/usr/bin/env bash

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "${current_script_path}")")

# shellcheck source=./template/lib/utils.bash
source "${plugin_dir}/template/lib/utils.bash"

version="${ASDF_INSTALL_VERSION}"
download_path="${ASDF_DOWNLOAD_PATH}"

[ -z "${version}" ] && fail "version argument required"
[ -z "${download_path}" ] && fail "ASDF_DOWNLOAD_PATH not set"

echo "* Cloning ${TOOL_NAME} repository..."
if [[ ! -d "${download_path}/.git" ]]; then
  git clone "${GH_REPO}" "${download_path}" --depth 1 || fail "git clone failed"
fi

echo "* Checking out version ${version}..."
git -C "${download_path}" fetch --tags --force

# Resolve tag â†’ commit explicitly, then hard reset
commit="$(git -C "${download_path}" rev-list -n 1 "v${version}" 2>/dev/null || git -C "${download_path}" rev-list -n 1 "${version}")"
[ -z "${commit}" ] && fail "could not resolve tag ${version}"

git -C "${download_path}" reset --hard "${commit}"

echo "* Checked out ${TOOL_NAME} @ ${commit}"
